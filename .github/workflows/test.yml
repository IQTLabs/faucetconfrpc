name: test

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - uses: actions/setup-go@v3
      with:
        go-version: '>=1.19.1'
    - run: go version
    - name: shell_test
      run: |
        wget "https://github.com/koalaman/shellcheck/releases/download/stable/shellcheck-stable.linux.x86_64.tar.xz" && \
        tar --xz -xvf "shellcheck-stable.linux.x86_64.tar.xz" && \
        shellcheck() { "shellcheck-stable/shellcheck" "$@"; } && \
        shellcheck --version && \
        /bin/bash --version && shellcheck -x -e SC2016 -e SC2119 -e SC2129 -e SC2001 -e SC2038 -e SC2044 certstrap/gen_faucetconfrpc_keys.sh
    - name: tests
      env:
        PYTHONPATH: "."
        GO111MODULE: "on"
      run: |
        go install github.com/square/certstrap@latest && \
        PATH=~/go/bin:$PATH certstrap -v && \
        sudo apt-get update && \
        sudo apt install -y libpython3-dev protobuf-compiler && \
        curl -sSL https://install.python-poetry.org | python3 - --version 1.1.15 && \
        poetry config virtualenvs.create false && \
        poetry install && \
        ./tests/codecheck.sh || true && \
        go install github.com/golang/protobuf/protoc-gen-go@latest && \
        go install google.golang.org/protobuf/cmd/protoc-gen-go@latest && \
        go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@latest && \
        cd src/faucetconfrpc && PATH=~/go/bin:$PATH ./generate_pb_grpc.sh && cd ../.. && \
        PATH=~/go/bin:$PATH pytest ./tests/test_faucetconfrpc.py && \
        docker buildx create --use && \
        docker buildx build \
          --platform linux/amd64,linux/arm64 \
          --file Dockerfile.server .
    - name: golang install test
      run: |
        echo "module iqtlabs/faucetconfrpc" > go.mod && \
        cd tests/gotest && echo -e "module gotest\nrequire (\n\tgithub.com/iqtlabs/faucetconfrpc latest\n\tgoogle.golang.org/grpc latest\n)\nreplace github.com/iqtlabs/faucetconfrpc => ../.." > go.mod && \
        cat go.mod && go mod download && go get gotest && go build && cd ../..
