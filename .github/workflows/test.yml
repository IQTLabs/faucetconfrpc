name: test

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - uses: actions/setup-go@v4
      with:
        go-version: '>=1.19.1'
    - run: go version
    - name: shell_test
      run: |
        wget "https://github.com/koalaman/shellcheck/releases/download/stable/shellcheck-stable.linux.x86_64.tar.xz" && \
        tar --xz -xvf "shellcheck-stable.linux.x86_64.tar.xz" && \
        shellcheck() { "shellcheck-stable/shellcheck" "$@"; } && \
        shellcheck --version && \
        /bin/bash --version && shellcheck -x -e SC2016 -e SC2119 -e SC2129 -e SC2001 -e SC2038 -e SC2044 certstrap/gen_faucetconfrpc_keys.sh
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    - name: Install Poetry
      uses: snok/install-poetry@v1
      with:
        virtualenvs-create: false
        virtualenvs-in-project: false
        version: 1.4.2
    - name: poetry install
      run: |
        poetry install
    - name: grpc install
      env:
        PYTHONPATH: "."
        GO111MODULE: "on"
      run: |
        go install github.com/square/certstrap@latest && \
        go install github.com/golang/protobuf/protoc-gen-go@latest && \
        go install google.golang.org/protobuf/cmd/protoc-gen-go@latest && \
        go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@latest && \
        PATH=~/go/bin:$PATH certstrap -v && \
        sudo apt-get update && sudo apt install -y protobuf-compiler && \
        cd src/faucetconfrpc && PATH=~/go/bin:$PATH ./generate_pb_grpc.sh && cd ../..
    - name: tests
      env:
        PYTHONPATH: "."
      run: |
        ./tests/codecheck.sh && \
        PATH=~/go/bin:$PATH pytest -s ./tests/test_faucetconfrpc.py && \
        sudo apt-get -y update && sudo apt-get -y install qemu-user ca-certificates curl gnupg && \
        for pkg in docker.io docker-doc docker-compose podman-docker containerd runc; do sudo apt-get remove $pkg; done \
        sudo install -m 0755 -d /etc/apt/keyrings \
        curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg \
        sudo chmod a+r /etc/apt/keyrings/docker.gpg \
        echo "deb [arch="$(dpkg --print-architecture)" signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
        "$(. /etc/os-release && echo "$VERSION_CODENAME")" stable" | \
        sudo tee /etc/apt/sources.list.d/docker.list > /dev/null \
        sudo apt-get -y update && \
        sudo apt-get -y install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin && \
        docker buildx create --buildkitd-flags '--allow-insecure-entitlement security.insecure' --use && \
        docker buildx build \
          --platform linux/arm/v7,linux/amd64,linux/arm64 \
          --file Dockerfile.server .
    - name: golang install test
      run: |
        echo "module iqtlabs/faucetconfrpc" > go.mod && \
        cd tests/gotest && echo -e "module gotest\nrequire (\n\tgithub.com/iqtlabs/faucetconfrpc latest\n\tgoogle.golang.org/grpc latest\n)\nreplace github.com/iqtlabs/faucetconfrpc => ../.." > go.mod && \
        cat go.mod && go mod download && go get gotest && go build && cd ../..
